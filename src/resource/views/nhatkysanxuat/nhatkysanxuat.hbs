<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Select2 CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-beta.1/css/select2.min.css" rel="stylesheet">
{{> header}}
{{>navbar}}

<main id="main" class="main">
    <div class="pagetitle">
        <h1>Nhật ký quá trình sản xuất </h1>
    </div><!-- End Page Title -->
    <section class="section dashboard">
        <div class="row">
            <div class="col-md-2">
                <!-- Recent Activity -->
                <div class="card">
                    <div class="card-body" style="text-align: center; ">
                        <h5 class="card-title" id="currentYear"> </h5>
                        <div class="row">
                            <div class="col-md-12">
                                <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                                    data-bs-target="#exampleModal">
                                    Thêm nhật ký
                                </button>
                                <br>
                                <br>
                                <a href="/nhatkysanxuat/storeList"> <button type="button" class="btn btn-success">Danh
                                        sách nhật ký</button> </a>

                            </div>
                        </div>
                        <br>
                    </div>
                </div><!-- End Recent Activity -->

            </div><!-- End Right side columns -->
            <!-- Left side columns -->
            <div class="col-md-10">
                <div class="row">
                    <!-- Reports -->
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <div id="calendar"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    {{!-- models thêm --}}
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog  modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Thêm Nhật Ký Quá Trình Sản Xuất</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="add-event-form">
                        <form id="event-form" method="POST">
                            <div class="row">
                                <div class="col-lg-6">
                                    <label class="event-title">Vụ Mùa</label>
                                    <select class="js-example-disabled-results form-select"
                                        aria-label="Default select example" name="vumua_id">
                                        {{#each vumua}}
                                        <option value="{{this._id}}">{{this.vumua}}</option>
                                        {{/each}}
                                    </select><br><br>
                                    <div class="form-group">
                                        <label class="event-title">Tên công việc</label>
                                        <input type="text" class="form-control" id="event-title" name="title" required>
                                    </div><br>
                                    <div class="row">
                                        <div class="col-lg-6">
                                            <label class="event-title">Giống cây</label>
                                            <select id="selectedGiongCay"
                                                class="js-example-disabled-results form-select"
                                                aria-label="Default select example" name="giongcay_id">
                                                {{#each giongcay}}
                                                <option value="{{this._id}}">{{this.giongcay}}</option>
                                                {{/each}}
                                            </select><br>
                                        </div>
                                        <div class="col-lg-6">
                                            <label class="event-title">Tên nguyên vật liệu</label>

                                            <select id="selectedNguyenLieu"
                                                class="js-example-disabled-results form-control"
                                                name="nguyenvatlieu_id">
                                                {{#each nguyenvatlieu}}
                                                <option value="{{this._id}}">{{this.name}}</option>
                                                {{/each}}
                                            </select>
                                        </div>
                                    </div>
                                    <br>
                                    <label class="event-title">Khu vực trồng (lô/thửa)</label>
                                    <select id="selectedArea" class=" js-example-disabled-results form-select"
                                        aria-label="Default select example" name="map_id">
                                        {{#each map}}
                                        <option value="{{this._id}}">{{this.namearea}}</option>
                                        {{/each}}
                                    </select>
                                    <br>
                                    <br>
                                    <div class="row">
                                        <div class="form-group col-lg-6">
                                            <label class="event-title">Thời gian bắt đầu</label>
                                            <input type="date" class="form-control" id="event-start" name="start"
                                                required>
                                        </div>
                                        <div class="form-group col-lg-6">
                                            <label class="event-title">Thời gian kết thúc</label>
                                            <input type="date" class="form-control" id="event-end" name="end" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="row">
                                        <div class="form-group col-lg-6">
                                            <label class="event-title">Nồng độ pha/bón</label>
                                            <input type="text" class="form-control" id="nongdo" name="nongdo" required>
                                        </div>
                                        <br>
                                        <div class="form-group col-lg-6">
                                            <label class="event-title">Tổng lượng sử dụng</label>
                                            <input type="text" class="form-control" id="luongsudung" name="luongsudung"
                                                required>
                                        </div>
                                    </div>
                                    <br>
                                    <div class="form-group">
                                        <label class="event-title">Thời gian cách ly</label>
                                        <input type="text" class="form-control" id="thoigiancachly"
                                            name="thoigiancachly" required>
                                    </div>
                                    <br>
                                    <div class="form-group">
                                        <label for="exampleFormControlTextarea1">Mục đích sử dụng</label>
                                        <input class="form-control" id="mucdich" name="mucdich" rows="3" required>
                                    </div>
                                    <br>
                                    <div class="form-group">
                                        <label class="event-title">Thiết bị sử dụng</label>
                                        <input type="text" class="form-control" id="thietbi" name="thietbi" required>
                                    </div>
                                    <br>
                                    <div class="form-group">
                                        <label class="event-title">Vệ sinh dụng cụ trước và sau khi sử dụng
                                            (Đ/K)</label>
                                        <select class="form-select" aria-label="Default select example"
                                            name="vesinhdungcu">
                                            <option value="Đ">Đúng</option>
                                            <option value="K">Không</option>
                                        </select>
                                    </div>
                                    <br>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-primary"
                                    style="width:250px;float:right;margin-left:20px">Thêm Mới
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                {{!-- <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Save changes</button>
                </div> --}}
            </div>
        </div>
    </div>

    {{!-- delete form --}}
    <form name="delete-calendar-form" method="POST"></form>

    {{!-- Confirm Delete Works --}}
    <div id="delete-work-modal" class="modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Xóa Lịch Làm Việc</h5>
                    {{!-- <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    --}}
                </div>
                <div class="modal-body">
                    <p>Bạn có chắc chắn muốn xóa lịch làm việc này không ?</p>
                </div>
                <div class="modal-footer">
                    <button id="btn-delete-calendar" type="button" class="btn btn-danger">Đồng ý xóa</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Thoát</button>
                </div>
            </div>
        </div>
    </div>
    {{!-- Confirm edit works --}}
</main>
{{> footer}}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<!-- Bootstrap JS -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/5.3.0-alpha1/js/bootstrap.bundle.min.js"></script>
<!-- Select2 JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-beta.1/js/select2.min.js"></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js'></script>

<script>

    $('#exampleModal').on('shown.bs.modal', function () {
        $(".js-example-disabled-results").select2({
            dropdownParent: $('#exampleModal') // Xác định modal là cha của dropdown
        });
    });
    // method delete 
    const exampleModal = document.getElementById('delete-work-modal')
    exampleModal.addEventListener('show.bs.modal', event => {

        var deleteForm = document.forms['delete-calendar-form']
        var btnDeleteCalendar = document.getElementById('btn-delete-calendar')
        const button = event.relatedTarget
        //get id from button delete
        const recipient = button.getAttribute('data-id')

        btnDeleteCalendar.onclick = function () {
            deleteForm.action = '/nhatkysanxuat/' + recipient + '?_method=DELETE'
            deleteForm.submit()
        }
    })
    //Show calendar
    function formatDate(dateString) {
        const parts = dateString.split('-');
        if (parts.length === 3) {
            return parts[2] + '-' + parts[1] + '-' + parts[0];
        }
        return dateString;
    }
    function Onclick() {

        $.ajax({
            url: '/nhatkysanxuat/store',
            type: 'GET',

        }).then(data => {
            function LoadData(dataWork) {
                var calendarEl = document.getElementById('calendar');
                var calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',

                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay'
                    },
                    events: dataWork,
                    locale: 'vi',

                },
                );
                calendar.render();

            }
            LoadData(data.works.map(obj => {
                return {
                    title: obj.title,
                    start: formatDate(obj.start),
                    end: formatDate(obj.end)
                }

            }))
        })
            .catch(err => {
                console.log(err)
            })
    }

    Onclick()
</script>

<script>

    const selectedGiongCayElement = $('#selectedGiongCay');
    const selectedNguyenLieuElement = $('#selectedNguyenLieu');
    const selectedAreaElement = $('#selectedArea');


    let selectedGiongCay = selectedGiongCayElement.val();
    let selectedNguyenLieu = selectedNguyenLieuElement.val();
    let selectedArea = selectedAreaElement.val();

    fetchGiongCay(selectedGiongCay, function (nguyenLieu) {
        selectedNguyenLieu = nguyenLieu;
        fetchData(selectedGiongCay, selectedNguyenLieu, selectedArea);
    });
    selectedGiongCayElement.on('change', function () {
        selectedGiongCay = selectedGiongCayElement.val();
        selectedNguyenLieu = selectedGiongCayElement.val();

        // Khi select thay đổi, gọi lại fetchData với giá trị mới
        fetchGiongCay(selectedGiongCay, function (nguyenLieu) {
            selectedNguyenLieu = nguyenLieu;
            fetchData(selectedGiongCay, selectedNguyenLieu, selectedArea);
        });
    });
    selectedNguyenLieuElement.on('change', function () {
        const selectedNguyenLieu = selectedNguyenLieuElement.val();

        // Khi select thay đổi, gọi lại fetchData với giá trị mới
        fetchData(selectedGiongCay, selectedNguyenLieu, selectedArea);
    });
    selectedAreaElement.on('change', function () {
        selectedArea = selectedAreaElement.val();

        // Khi select thay đổi, gọi lại fetchData với giá trị mới
        fetchData(selectedGiongCay, selectedNguyenLieu, selectedArea);
    });

    function fetchData(option1, option2, option3) {
        fetch(`/nguyenvatlieu/getData/${option1}/${option2}/${option3}`)
            .then(response => response.json())
            .then(data => {
                const match = (data.data.lieuluong).match(/[\d\.,]+/);;
                var donVi = (data.data.lieuluong).match(/[^\d\s,]+/);

                var number = parseFloat(match[0].replace(',', '.'));

                // Cập nhật giá trị của các ô input sau khi nhận dữ liệu từ server
                $('#thoigiancachly').val(data.data.thoigiancachlythuoc);
                $('#nongdo').val(data.data.nongdo);
                $('#luongsudung').val((number * (data.map.areaMeter / 10000)).toFixed(2) + ` ${donVi[0]}`);
                $('#mucdich').val(data.data.mucdich);
                $('#thietbi').val(data.data.thietbi);
                // Cập nhật các ô input khác nếu cần
            })
            .catch(error => console.error('Error:', error));
    }
    // Khi trang được tải lên, gọi fetchData để lấy dữ liệu ban đầu

    function fetchGiongCay(option, callback) {
        fetch(`/nguyenvatlieu/getGiongCay/${option}`)
            .then(response => response.json())
            .then(data => {
                selectedNguyenLieuElement.empty();

                // Lặp qua mảng dữ liệu và thêm mỗi phần tử vào phần tử select
                $.each(data, function (index, nguyenvatlieu) {
                    var optionElement = $('<option>'); // Tạo một phần tử option mới
                    optionElement.val(nguyenvatlieu._id); // Thiết lập giá trị của option
                    optionElement.text(nguyenvatlieu.name); // Thiết lập nội dung văn bản của option
                    selectedNguyenLieuElement.append(optionElement); // Thêm option vào phần tử select
                });
                callback(selectedNguyenLieuElement.val());
            })

    }


</script>