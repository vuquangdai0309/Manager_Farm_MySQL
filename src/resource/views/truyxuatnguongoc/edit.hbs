<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Select2 CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-beta.1/css/select2.min.css" rel="stylesheet">
{{> header}}
{{>navbar}}
<main id="main" class="main">
    <div class="pagetitle">
        <div class="row">
            <div class="col-md-5">
                <h1>Truy xuất nguồn gốc sản phấm</h1>
            </div>
        </div>
    </div><!-- End Page Title -->
    <div class="row">
        <div class="col-md-6">
            <div class="row">
                <div class="col-md-6">
                    <label class="event-title">Code</label>
                    <input type="text" class="form-control" id="code" name="code" value="{{data.code}}" required>
                </div><br>

                <div class="col-md-6">
                    <label class="event-title">Khu vườn</label>
                    <select id="map_id" class="js-example-disabled-results form-select"
                        aria-label="Default select example" name="map_id" show-value="{{data.map_id}}">
                        {{#each maps}}
                        <option value="{{this._id}}">{{this.namearea}}</option>
                        {{/each}}
                    </select><br>
                </div>
            </div>
            <br>
            <div class="form-group">
                <label class="event-title">Tên truy xuất </label>
                <input type="text" class="form-control" id="title" name="title" value="{{data.title}}" required>
            </div><br>
            <div class="form-group">
                <label class="event-title">Đơn vị sản xuất </label>
                <input type="text" class="form-control" id="productionUnit" name="productionUnit"
                    value="{{data.productionUnit}}" required>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label for="recipient-name" class="col-form-label">Hình ảnh:
                    <img id="imagePreview" UrlImage="{{data.image}}" src="/{{data.image}}" alt="Preview" width="50px">
                </label><br>
                <input type="file" class="form-control" id="image" name="image" style="display: none;">
                <input type="text" class="form-control" id="imageurl" name="imageurl" style="display: none;"
                    value="{{data.image}}">
            </div>
            <div class="form-group">
                <label class="event-title">Số điện thoại</label>
                <input type="text" class="form-control" id="phone" name="phone" value="{{data.phone}}">
            </div>
            <br>
            <div class="form-group">
                <label for="exampleFormControlTextarea1">Email</label>
                <input type="text" class="form-control" id="email" name="email" value="{{data.email}}">
            </div>
            <br>
            <div class="form-group">
                <label class="event-title">Đia chỉ</label>
                <input type="text" class="form-control" id="address" name="address" value="{{data.address}}">
            </div>

        </div>
    </div>
    <div class="form-group">
        <input type="hidden" id="content" value="{{data.content}}">
        <label for="recipient-name" class="col-form-label"><strong>Nội dung</strong>
        </label><br>
        <div id="editor" style="min-height: 300px;"></div>
        <div id="getcontent" style="display: none;" getid="{{data.truyxuat_id}}"></div>
    </div>
    <span id="message" style="color:red; float:right"></span>
    <br>
    <div class="modal-footer">
        <button type="button" class="btn btn-primary" onclick="onclickItem()"
            style="width:250px;float:right;margin-left:20px">Chỉnh sửa
        </button>
    </div>

</main>
{{> footer}}
{{!-- form delete --}}
<form name="delete-item-form" method="POST"></form>
<script src="/js/checkbox.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.2/tinymce.min.js"> </script>
<script src="/js/tinymce.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<!-- Bootstrap JS -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/5.3.0-alpha1/js/bootstrap.bundle.min.js"></script>
<!-- Select2 JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-beta.1/js/select2.min.js"></script>
<script>
    $(document).ready(function () {
        $('.js-example-disabled-results').select2();
    });

    const getcontent = document.getElementById('getcontent')
    const content = document.getElementById('content').value

    getcontent.innerHTML = content
    var contentWithHTML = document.getElementById('getcontent').innerHTML;
    //getid
    const getid = getcontent.getAttribute('getid')
    //Edit content
    tinymceFuntionsProduct(contentWithHTML)

    let showAreaId = $('#map_id');
    let getAttrAreaId = showAreaId.attr('show-value');
    function showSelected(showElement, value) {
        let valueFromDatabase = value;
        let selectElement = showElement;

        selectElement.find('option').each(function () {
            if ($(this).val() === valueFromDatabase) {
                $(this).prop('selected', true);
                return false; // Dừng vòng lặp nếu đã tìm thấy giá trị
            }
        });
    }
    showSelected(showAreaId, getAttrAreaId)


    var img = document.getElementById('image')
    var imagePreview = document.getElementById('imagePreview')
    var UrlImage = imagePreview.getAttribute('UrlImage')
    // Khi click vào ảnh, chuyển sự kiện click đến trường nhập file
    imagePreview.addEventListener('click', function () {
        img.click();
    });
    // change ảnh khi chọn
    img.addEventListener('change', function () {
        imagePreview.src = URL.createObjectURL(img.files[0])

    });

    function onclickItem() {
        const tinymceHtmlContent = tinymce.get('editor').getContent()
        const title = document.getElementById('title').value
        const map_id = document.getElementById('map_id').value
        const code = document.getElementById('code').value
        const phone = document.getElementById('phone').value
        const email = document.getElementById('email').value
        const address = document.getElementById('address').value
        const productionUnit = document.getElementById('productionUnit').value
        const file = img.files[0]

        if (title && tinymceHtmlContent && code && phone && email && address && productionUnit) {

            const formData = new FormData();
            formData.append('image', file);
            formData.append('code', code);
            formData.append('title', title);
            formData.append('map_id', map_id);
            formData.append('productionUnit', productionUnit);
            formData.append('phone', phone);
            formData.append('email', email);
            formData.append('imageurl', UrlImage);
            formData.append('address', address);
            formData.append('editor', tinymceHtmlContent);
            fetch(`/truyxuatnguongoc/${getid}/update`, {
                method: 'POST',
                body: formData,
            }).then(() => {
                window.location.replace('/truyxuatnguongoc/quan-ly')
            })
        }
        else {
            const message = document.getElementById('message')
            message.innerText = 'Vui lòng nhập đầy đủ các trường thông tin !'
        }
    }
</script>